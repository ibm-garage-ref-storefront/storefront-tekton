# Prevail 2021 : DevQosOps Workshop - Availability Track

## Steps

Please execute the steps as mentioned below.

**1. Clone the code.**

```
git clone https://github.com/soumensaha001/prevail_availability.git
```

In this repository, `automated-demo` folder contains the scripts and readme to do setup automatically. The manual steps are also provided in the root folder of the cloned repository for your better understanding.

**2. Login to OpenShift Cluster.**

On console, please run the following command to verify if you are already logged-in.

```
oc whoami
```

If the command returns `error: You must be logged in to the server (Unauthorized)`, then follow the below step to login else go to next step.

From the OpenShift web console, click the menu in the upper right corner (the label contains your email address), and select Copy Login Command. 

<img width="728" alt="image" src="https://user-images.githubusercontent.com/10827415/137897756-c10cd4e8-bc9c-4473-aafa-01384ee9df38.png">


Click Display token and paste the command into a terminal session. For example:

```
oc login --token=xxxx --server=https://xxxx.containers.cloud.ibm.com:xxx
```

**3. Change the working directory to `automated-demo` and add execute permission to the script.**

```
cd prevail_availability/automated-demo
chmod +x setup-availability-trail.sh
chmod +x scripts/*.sh
```

**4. Execute the script as shown.**

```
./setup-availability-trail.sh
```

> NOTE: The script uses two project named as `istio-system` and `bookinfo`. These names are mentioned in the starting of the script and can be changed if required.

On execution, you will see the following output on your terminal.

```
Checking if you are already logged-in to OpenShift Cluster
IAM#xxx

You are already logged-in.

 1) install Elastic Search Operator
 2) install Jaeger Operator
 3) install Kiali Operator
 4) install Service Mesh Operator
 5) create Project
 6) create Service-Mesh Control Plane Service
 7) create Service-Mesh Member Roll Service
 8) deploy Sample Application
 9) access the Sample Application
10) install Chaos Toolkit and its Kubernetes extension
11) Quit
Please enter your choice: 
```

Here, you need to perform all the steps one-by-one. It will install all the required operators, create project, deploy application and install chaos toolkit.

***4.1 Choose `1`***

It will install Elastic Search operator. If you see the following message on your screen, then the operator has been installed successfully. 

```
subscription.operators.coreos.com/elasticsearch-operator created

Operator installed successfully.
```

Go to `OpenShift web console > Operators > Installed Operators` and verify if the operator has been installed.

***4.2 Choose `2`***

Perform the same as previous one.

***4.3 Choose `3`***

Perform the same as previous one.

***4.4 Choose `4`***

Perform the same as previous one.

***4.5 Choose `5`***

It will create a project `bookinfo` for your sample application.

***4.6 Choose `6`***

It will create the service instance of service mesh control plane to be used by the application. You can verify it using OpenShift web console under `istio-system` project.

***4.7 Choose `7`***

It will create the service instance of service mesh member roll which will be used by the application. You can verify it using OpenShift web console under `istio-system` project.

***4.8 Choose `8`***

This step will deploy the application using the deployment configuration `https://raw.githubusercontent.com/Maistra/istio/maistra-2.0/samples/bookinfo/platform/kube/bookinfo.yaml`

***4.9 Choose `9`***

This step will provide you the route to access the deployed application. Make a note of the application route, it will be used in further steps.

Till this step, the sample application provided has been deployed with all the required operators.

***4.10 Choose `10`***

This step will install the chaos toolkit and its extension to run experiments.

After this, you will generate the fake traffic and run the experiments to kill application pods to test the application availability.

***4.11 Choose `11`***

Exits the script.

## Access the different dashboards

Go to OpenShift web console and access `istio-system` project. It will show as:

![image](https://user-images.githubusercontent.com/45451838/128295542-00ae1107-c424-4e1e-be91-a06032a784a2.png)

![image](https://user-images.githubusercontent.com/45451838/128295522-46591c5c-3a7e-4131-a970-100a6ee9472c.png)

Access the Kiali, Grafana, Jaeger dashboards to analyse the deployed application.


## Fake traffic generation

Traffic can be generated by using following inline script. Please replace the application route with its value as noted in `step 4.9`.

```
for i in {1..20}; do sleep 0.5; curl -I <application-route>/productpage; done
```

## Experiment to kill application pod

One of the chaos experiment can be run as:

```
source ~/.venvs/chaostk/bin/activate
chaos run chaos/terminate-pod.yaml
```

## Analyze the results through the different dashboards

You can check kiali, grafana, jaeger dashboards to analyse availability/resiliency of the full system.
